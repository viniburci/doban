<div class="gerador-container">
  <div class="header">
    <h4>Gerar Documento Dinamico</h4>
    <button type="button" class="btn-close" (click)="fechar()"></button>
  </div>

  <!-- Selecao de Template -->
  <div class="mb-3">
    <label class="form-label">Selecione o Template</label>
    <select class="form-select"
      [value]="templateSelecionado()?.id ?? ''"
      (change)="selecionarTemplate(+$any($event.target).value)">
      <option value="" disabled>Escolha um template...</option>
      @for (template of templates(); track template.id) {
        <option [value]="template.id">{{ template.nome }}</option>
      }
    </select>
  </div>

  @if (carregando()) {
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>
  }

  @if (templateSelecionado() && dadosTemplate() && !carregando()) {
    <!-- Info do Schema -->
    <div class="schema-info">
      <div class="schema-info-header">
        <span class="schema-info-label">Campos por item:</span>
      </div>
      <div class="schema-info-campos">
        <span class="schema-campo-tag campo-fixo">Descricao</span>
        <span class="schema-campo-tag campo-fixo">Quantidade</span>
        @for (field of schemaFields(); track field.nome) {
          @if (field.nome !== 'descricao' && field.nome !== 'quantidade') {
            <span class="schema-campo-tag" [class.campo-obrigatorio]="field.obrigatorio">
              {{ field.rotulo || field.nome }}
              @if (field.obrigatorio) {
                <span class="obrigatorio-mark">*</span>
              }
            </span>
          }
        }
      </div>
    </div>

    <!-- Edicao de Itens -->
    <div class="itens-section">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label mb-0">Itens do Documento</label>
        <button type="button" class="btn btn-sm btn-outline-primary" (click)="adicionarItem()">
          + Adicionar Item
        </button>
      </div>

      @if (temItens()) {
        <div class="itens-lista">
          @for (item of itens(); track $index; let i = $index) {
            <div class="item-card">
              <div class="item-header">
                <span class="item-numero">Item {{ i + 1 }}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="removerItem(i)">
                  Remover
                </button>
              </div>
              <div class="item-fields">
                <!-- Campo Descricao -->
                <div class="field-group">
                  <label class="form-label">Descricao</label>
                  <input type="text" class="form-control form-control-sm"
                    [ngModel]="item.descricao"
                    (ngModelChange)="atualizarItem(i, 'descricao', $event)">
                </div>

                <!-- Campo Quantidade -->
                <div class="field-group">
                  <label class="form-label">Quantidade</label>
                  <input type="number" class="form-control form-control-sm"
                    [ngModel]="item.quantidade"
                    (ngModelChange)="atualizarItem(i, 'quantidade', $event)"
                    min="1">
                </div>

                <!-- Campos Dinamicos do Schema -->
                @for (field of schemaFields(); track field.nome) {
                  @if (field.nome !== 'descricao' && field.nome !== 'quantidade') {
                    <div class="field-group">
                      <label class="form-label">{{ field.rotulo }}</label>
                      @if (field.tipo === 'ENUM' && field.opcoes) {
                        <select class="form-select form-select-sm"
                          [ngModel]="item[field.nome]"
                          (ngModelChange)="atualizarItem(i, field.nome, $event)">
                          <option value="">Selecione...</option>
                          @for (opcao of field.opcoes; track opcao) {
                            <option [value]="opcao">{{ opcao }}</option>
                          }
                        </select>
                      } @else if (field.tipo === 'BOOLEAN') {
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input"
                            [ngModel]="item[field.nome]"
                            (ngModelChange)="atualizarItem(i, field.nome, $event)">
                        </div>
                      } @else {
                        <input [type]="getInputType(field.tipo)" class="form-control form-control-sm"
                          [ngModel]="item[field.nome]"
                          (ngModelChange)="atualizarItem(i, field.nome, $event)">
                      }
                    </div>
                  }
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state-small">
          <p class="text-muted mb-0">Nenhum item adicionado</p>
        </div>
      }
    </div>

    <!-- Acoes -->
    <div class="acoes-section">
      <button type="button" class="btn btn-outline-secondary" (click)="visualizarPreview()"
        [disabled]="carregando()">
        Preview
      </button>
      <button type="button" class="btn btn-primary" (click)="gerarDocumento()"
        [disabled]="gerando()">
        @if (gerando()) {
          <span class="spinner-border spinner-border-sm me-2"></span>
          Gerando...
        } @else {
          Gerar PDF
        }
      </button>
    </div>
  }

  <!-- Modal de Preview -->
  @if (mostrarPreview() && previewHtml()) {
    <div class="preview-overlay" (click)="fecharPreview()">
      <div class="preview-modal" (click)="$event.stopPropagation()">
        <div class="preview-header">
          <h5>Preview do Documento</h5>
          <button type="button" class="btn-close" (click)="fecharPreview()"></button>
        </div>
        <div class="preview-content">
          <iframe [srcdoc]="previewHtml()" class="preview-iframe"></iframe>
        </div>
      </div>
    </div>
  }
</div>
