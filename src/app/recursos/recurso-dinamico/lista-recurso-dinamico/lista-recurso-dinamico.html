<div class="container-fluid">
  <div class="header-section">
    <h1 class="page-title">Empr√©stimos de Recursos</h1>
    <div class="header-actions">
      <select class="form-select filter-select" [ngModel]="filtroTipo()" (ngModelChange)="onFiltroTipoChange($event)">
        <option value="">Todos os tipos</option>
        @for (tipo of tiposRecurso(); track tipo.id) {
          <option [value]="tipo.codigo">{{ tipo.nome }}</option>
        }
      </select>
      <select class="form-select filter-select" [ngModel]="filtroStatus()" (ngModelChange)="onFiltroStatusChange($event)">
        <option value="">Todos os status</option>
        <option value="emprestado">Emprestados</option>
        <option value="devolvido">Devolvidos</option>
      </select>
      <button type="button" class="btn btn-primary" [routerLink]="['/emprestimos/novo']">
        Novo Empr√©stimo
      </button>
    </div>
  </div>

  <div class="recursos-list">
    @if (loading()) {
      <div class="loading-state">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
      </div>
    } @else if (recursos().length > 0) {
      @for (recurso of recursos(); track recurso.id) {
        <div class="recurso-card" [class.emprestado]="isEmprestado(recurso)" [class.devolvido]="!isEmprestado(recurso)" [class.expandido]="recurso.id === recursoExpandido()">
          <div class="recurso-card-header" (click)="toggleExpand(recurso.id!)">
            <div class="recurso-info">
              <div class="recurso-header">
                <h5 class="recurso-item">{{ recurso.item.identificador }}</h5>
                <span class="recurso-tipo-badge">{{ recurso.item.tipoRecursoNome }}</span>
              </div>
              <p class="recurso-pessoa">
                <strong>Pessoa:</strong> {{ recurso.pessoaNome }}
              </p>
              <div class="recurso-datas">
                <span class="data-entrega">
                  <strong>Entrega:</strong> {{ formatarData(recurso.dataEntrega) }}
                </span>
                @if (recurso.dataDevolucao) {
                  <span class="data-devolucao">
                    <strong>Devolu√ß√£o:</strong> {{ formatarData(recurso.dataDevolucao) }}
                  </span>
                }
              </div>
            </div>
            <div class="recurso-actions-compact">
              <span class="badge" [class.bg-warning]="isEmprestado(recurso)" [class.bg-success]="!isEmprestado(recurso)">
                {{ isEmprestado(recurso) ? 'Emprestado' : 'Devolvido' }}
              </span>
              <i class="bi" [class.bi-chevron-down]="recurso.id !== recursoExpandido()" [class.bi-chevron-up]="recurso.id === recursoExpandido()"></i>
            </div>
          </div>

          @if (recurso.id === recursoExpandido()) {
            <div class="recurso-detalhes">
              <div class="detalhes-grid">
                <div class="detalhe-item">
                  <strong>Pessoa:</strong>
                  <a [routerLink]="['/pessoas', recurso.pessoaId, 'detalhes']">{{ recurso.pessoaNome }}</a>
                </div>
                <div class="detalhe-item">
                  <strong>Item:</strong>
                  <a [routerLink]="['/itens', recurso.item.id, 'detalhes']">{{ recurso.item.identificador }}</a>
                </div>
                @for (attr of getAtributos(recurso.atributosSnapshot ?? recurso.item.atributos); track attr.key) {
                  <div class="detalhe-item">
                    <strong>{{ attr.key }}:</strong> {{ attr.value }}
                  </div>
                }
              </div>
              <div class="recurso-actions">
                @if (isEmprestado(recurso)) {
                  <button type="button" class="btn btn-sm btn-success" (click)="registrarDevolucao(recurso); $event.stopPropagation()">
                    Registrar Devolu√ß√£o
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    } @else {
      <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <p class="empty-state-text">Nenhum empr√©stimo encontrado</p>
        <button type="button" class="btn btn-outline-primary" [routerLink]="['/emprestimos/novo']">
          Registrar primeiro empr√©stimo
        </button>
      </div>
    }
  </div>
</div>
