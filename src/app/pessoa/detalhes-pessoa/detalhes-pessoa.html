<div class="container-fluid">
  <!-- Primeira Linha: pessoa()? + Vagas + Impressão -->
  <div class="row">

    <!-- COLUNA 1: DETALHES DA pessoa()? -->
    <div class="col-lg-3 col-md-4">
      @if (pessoa() != null && errorMessage == null) {
        <div class="card">
          <div class="card-body">
            <!-- Header do Card -->
            <h5 class="card-title">{{ pessoa()?.nome || 'Nome não disponível' }}</h5>
            <h6 class="card-subtitle">{{ pessoa()?.email || 'Email não disponível' }}</h6>

            <!-- SEÇÃO: CONTATO -->
            <div class="section-header">Contato</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Telefone</span>
                <span class="info-value">{{ pessoa()?.telefone || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Chave Pix</span>
                <span class="info-value">{{ pessoa()?.chavePix || '-' }}</span>
              </div>
            </div>

            <!-- SEÇÃO: ENDEREÇO -->
            <div class="section-header">Endereço</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Logradouro</span>
                <span class="info-value">{{ pessoa()?.endereco || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Complemento</span>
                <span class="info-value">{{ pessoa()?.complemento || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Bairro</span>
                <span class="info-value">{{ pessoa()?.bairro || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Cidade/UF</span>
                <span class="info-value">{{ pessoa()?.cidade || '-' }}/{{ pessoa()?.estado || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">CEP</span>
                <span class="info-value">{{ pessoa()?.cep || '-' }}</span>
              </div>
            </div>

            <!-- SEÇÃO: DOCUMENTOS -->
            <div class="section-header">Documentos</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">CPF</span>
                <span class="info-value">{{ pessoa()?.cpf || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">RG</span>
                <span class="info-value">{{ pessoa()?.numeroRg || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Emissão RG</span>
                <span class="info-value">{{ pessoa()?.dataEmissaoRg || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">UF RG</span>
                <span class="info-value">{{ pessoa()?.ufRg || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">PIS</span>
                <span class="info-value">{{ pessoa()?.pis || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Título Eleitor</span>
                <span class="info-value">{{ pessoa()?.tituloEleitor || '-' }}</span>
              </div>
            </div>

            <!-- SEÇÃO: CTPS -->
            <div class="section-header">CTPS</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Número</span>
                <span class="info-value">{{ pessoa()?.numeroCtps || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Série</span>
                <span class="info-value">{{ pessoa()?.serieCtps || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Emissão</span>
                <span class="info-value">{{ pessoa()?.dataEmissaoCtps || '-' }}</span>
              </div>
            </div>

            <!-- SEÇÃO: CNH -->
            <div class="section-header">CNH</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Número</span>
                <span class="info-value">{{ pessoa()?.numeroCnh || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Categoria</span>
                <span class="info-value">{{ pessoa()?.categoriaCnh || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Registro</span>
                <span class="info-value">{{ pessoa()?.registroCnh || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Validade</span>
                <span class="info-value">{{ pessoa()?.validadeCnh || '-' }}</span>
              </div>
            </div>

            <!-- SEÇÃO: DADOS PESSOAIS -->
            <div class="section-header">Dados Pessoais</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Nascimento</span>
                <span class="info-value">{{ pessoa()?.dataNascimento || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Local Nasc.</span>
                <span class="info-value">{{ pessoa()?.localNascimento || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Estado Civil</span>
                <span class="info-value">{{ pessoa()?.estadoCivil || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Mãe</span>
                <span class="info-value">{{ pessoa()?.mae || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Pai</span>
                <span class="info-value">{{ pessoa()?.pai || '-' }}</span>
              </div>
            </div>

            <!-- Botão Editar -->
            <a [routerLink]="['/pessoas', pessoa()?.id, 'editar']" class="btn btn-primary w-100 mt-3">
              Editar Informações
            </a>
          </div>
        </div>
      }
      @else if (errorMessage != null) {
        <div class="alert alert-danger" role="alert">
          {{ errorMessage }}
        </div>
      }
    </div>

    <!-- COLUNA 2: VAGAS -->
    <div class="col-lg-6 col-md-5">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Vagas</h5>

          @if ((vagasPessoa()?.length || 0) > 0) {
            @for(vaga of vagasPessoa(); track vaga.id) {
              <app-card-vaga [vaga]="vaga" (editarVaga)="editarVaga($event)"></app-card-vaga>
            }
          } @else {
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <p class="empty-state-text">Nenhuma vaga registrada</p>
            </div>
          }

          <button class="btn btn-primary w-100 mt-3" (click)="toggleRegistrarVaga()">
            Registrar Nova Vaga
          </button>
        </div>
      </div>
    </div>

    <!-- COLUNA 3: DOCUMENTOS -->
    <div class="col-lg-3 col-md-3">
      <div class="card documentos-section">
        <div class="card-body">
          <h5 class="card-title">Gerar Documentos</h5>

          <!-- Selecao de Vaga -->
          @if ((vagasPessoa()?.length || 0) > 0) {
            <div class="mb-3">
              <label class="form-label">Selecione a Vaga</label>
              <select class="form-select form-select-sm"
                [value]="vagaSelecionadaParaDocumento() ?? ''"
                (change)="selecionarVagaParaDocumento(+$any($event.target).value)">
                <option value="" disabled>Escolha uma vaga...</option>
                @for (vaga of vagasPessoa(); track vaga.id) {
                  <option [value]="vaga.id">{{ vaga.clienteNome }} - {{ vaga.tipoVagaNome }}</option>
                }
              </select>
            </div>

            @if (vagaSelecionadaParaDocumento()) {
              <!-- Selecao de Documentos -->
              <div class="documentos-lista">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="form-label mb-0">Tipos de Documento</span>
                  <button type="button" class="btn btn-link btn-sm p-0"
                    (click)="selecionarTodosDocumentos(!temDocumentoSelecionado())">
                    {{ temDocumentoSelecionado() ? 'Limpar' : 'Selecionar todos' }}
                  </button>
                </div>

                @for (tipo of tiposDocumentos(); track tipo.id) {
                  <div class="form-check documento-item">
                    <input class="form-check-input" type="checkbox"
                      [id]="'doc-' + tipo.id"
                      [checked]="tipo.selecionado"
                      (change)="toggleDocumento(tipo.id)">
                    <label class="form-check-label" [for]="'doc-' + tipo.id"
                      [title]="tipo.descricao">
                      {{ tipo.nome }}
                    </label>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-individual"
                      (click)="gerarDocumentoIndividual(tipo.id)"
                      [disabled]="gerandoDocumento()"
                      title="Gerar apenas este documento">
                      PDF
                    </button>
                  </div>
                }
              </div>

              <!-- Botao Gerar Combinados -->
              <button type="button" class="btn btn-primary w-100 mt-3"
                [disabled]="!temDocumentoSelecionado() || gerandoDocumento()"
                (click)="gerarDocumentosCombinados()">
                @if (gerandoDocumento()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Gerando...
                } @else {
                  Gerar PDF Combinado ({{ quantidadeSelecionados() }})
                }
              </button>
            }
          } @else {
            <div class="empty-state-small">
              <p class="text-muted mb-0">Cadastre uma vaga para gerar documentos</p>
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- SEÇÃO DE RECURSOS DINÂMICOS -->
  <div class="recursos-section">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Recursos Emprestados</h5>
          @if (temRecursoSelecionado()) {
            <div class="recursos-acoes">
              <span class="badge bg-primary me-2">1 selecionado</span>
              <button type="button" class="btn btn-sm btn-outline-secondary"
                (click)="limparSelecaoRecursos()">
                Limpar
              </button>
            </div>
          }
        </div>

        <!-- Filtros por tipo -->
        <div class="tipo-filters mb-3">
          <button
            class="btn btn-sm"
            [class.btn-primary]="tipoFiltroSelecionado() === null"
            [class.btn-outline-primary]="tipoFiltroSelecionado() !== null"
            (click)="filtrarPorTipo(null)">
            Todos ({{ recursosDinamicos().length || 0 }})
          </button>
          @for(tipo of contadorPorTipo(); track tipo.codigo) {
            <button
              class="btn btn-sm"
              [class.btn-primary]="tipoFiltroSelecionado() === tipo.codigo"
              [class.btn-outline-primary]="tipoFiltroSelecionado() !== tipo.codigo"
              (click)="filtrarPorTipo(tipo.codigo)">
              {{ tipo.nome }} ({{ tipo.count }})
            </button>
          }
        </div>

        <!-- Grid de cards -->
        <div class="row">
          @if ((recursosFiltrados().length || 0) > 0) {
            @for(recurso of recursosFiltrados(); track recurso.id) {
              <div class="col-lg-4 col-md-6 mb-3">
                <div class="recurso-wrapper" [class.recurso-selecionado]="isRecursoSelecionado(recurso.id!)">
                  <div class="recurso-checkbox">
                    <input type="checkbox" class="form-check-input"
                      [checked]="isRecursoSelecionado(recurso.id!)"
                      (change)="toggleRecursoSelecionado(recurso.id!)"
                      title="Selecionar para gerar documento">
                  </div>
                  <app-card-recurso-dinamico
                    [recurso]="recurso"
                    (editarRecurso)="editarEmprestimo($event)"
                    (updated)="updateComponent()">
                  </app-card-recurso-dinamico>
                </div>
              </div>
            }
          } @else {
            <div class="col-12">
              <div class="empty-state">
                <div class="empty-state-icon"></div>
                <p class="empty-state-text">
                  @if(tipoFiltroSelecionado()) {
                    Nenhum recurso deste tipo registrado
                  } @else {
                    Nenhum recurso emprestado
                  }
                </p>
              </div>
            </div>
          }
        </div>

        <!-- Secao de itens extras para termo -->
        @if (tipoRecursoSelecionado() === 'CELULAR') {
          <div class="card mt-3">
            <div class="card-body">
              <h6 class="card-title">Itens Extras do Emprestimo</h6>

              <div class="mb-3">
                <label class="form-label">Cliente (para documento)</label>
                <select class="form-select form-select-sm"
                  [value]="clienteSelecionadoId() ?? ''"
                  (change)="selecionarCliente($any($event.target).value ? +$any($event.target).value : null)">
                  <option value="">Sem cliente</option>
                  @for (cliente of clientes(); track cliente.id) {
                    <option [value]="cliente.id">{{ cliente.nome }}</option>
                  }
                </select>
              </div>

              <label class="form-label fw-bold">Adicionar Item Extra</label>
              <form [formGroup]="itemExtraForm" (ngSubmit)="adicionarItemExtra()" class="row g-2 align-items-end mb-3">
                <div class="col-md-3">
                  <label class="form-label">Descricao *</label>
                  <input type="text" class="form-control form-control-sm" formControlName="descricao">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Marca</label>
                  <input type="text" class="form-control form-control-sm" formControlName="marca">
                </div>
                <div class="col-md-2">
                  <label class="form-label">N. Serie</label>
                  <input type="text" class="form-control form-control-sm" formControlName="numeroSerie">
                </div>
                <div class="col-md-1">
                  <label class="form-label">DDD</label>
                  <input type="text" class="form-control form-control-sm" formControlName="ddd">
                </div>
                <div class="col-md-1">
                  <label class="form-label">Qtd</label>
                  <input type="number" class="form-control form-control-sm" formControlName="quantidade" min="1">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Valor</label>
                  <input type="number" class="form-control form-control-sm" formControlName="valor" min="0" step="0.01">
                </div>
                <div class="col-md-1">
                  <button type="submit" class="btn btn-sm btn-outline-primary w-100"
                    [disabled]="itemExtraForm.invalid">
                    +
                  </button>
                </div>
              </form>

              @if (itensExtrasEditaveis().length > 0) {
                <table class="table table-sm table-bordered mb-3">
                  <thead>
                    <tr>
                      <th>Descricao</th>
                      <th>Marca</th>
                      <th>N. Serie</th>
                      <th>DDD</th>
                      <th>Qtd</th>
                      <th>Valor</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of itensExtrasEditaveis(); track $index) {
                      <tr>
                        <td>{{ item.descricao }}</td>
                        <td>{{ item.marca || '-' }}</td>
                        <td>{{ item.numeroSerie || '-' }}</td>
                        <td>{{ item.ddd || '-' }}</td>
                        <td>{{ item.quantidade || 1 }}</td>
                        <td>{{ item.valor || 0 }}</td>
                        <td>
                          <button type="button" class="btn btn-sm btn-outline-danger" (click)="removerItemExtra($index)">
                            X
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              }

              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-primary"
                  (click)="salvarItensExtras()"
                  [disabled]="salvandoItensExtras()"
                  title="Salvar itens extras no emprestimo">
                  @if (salvandoItensExtras()) {
                    Salvando...
                  } @else {
                    Salvar Itens
                  }
                </button>
                <button type="button" class="btn btn-sm btn-success"
                  (click)="gerarTermoResponsabilidade()"
                  [disabled]="gerandoDocumento()"
                  title="Gerar termo de responsabilidade para emprestimo">
                  Termo Emprestimo
                </button>
                <button type="button" class="btn btn-sm btn-warning"
                  (click)="gerarDeclaracaoDevolucao()"
                  [disabled]="gerandoDocumento()"
                  title="Gerar declaracao de devolucao">
                  Declaracao Devolucao
                </button>
              </div>
            </div>
          </div>
        }

        <button class="btn btn-primary mt-3" (click)="novoEmprestimo()">
          Registrar Emprestimo
        </button>
      </div>
    </div>
  </div>

  <!-- FORMULÁRIOS DE REGISTRO -->
  @if(showRegistrarVaga()) {
    <div class="card mt-4 fade-in">
      <div class="card-body">
        <app-cadastro-vaga #vagaForm appScrollOnRender (updated)="handleUpdateAndClose()"
          [editVaga]="editVaga() ? editVaga() : null" (close)="handleOnlyClose()"
          (closeForm)="handleOnlyClose()" [pessoaId]="pessoaId()">
        </app-cadastro-vaga>
      </div>
    </div>
  }

  @if (showFormRecursoDinamico()) {
    <div class="card mt-4 fade-in">
      <div class="card-body">
        <app-form-recurso-dinamico
          appScrollOnRender
          [pessoaId]="pessoaId()"
          [editRecurso]="editRecursoDinamico()"
          (updated)="handleUpdateAndClose()"
          (closeForm)="handleOnlyClose()">
        </app-form-recurso-dinamico>
      </div>
    </div>
  }
</div>
